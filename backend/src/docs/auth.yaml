# Authentication API Documentation
# Story 11.3: API Documentation

paths:
  /api/auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user
      description: |
        Create a new user account with username, email, and password.

        **Rate Limit**: 5 requests per hour per IP

        **Password Requirements**:
        - Minimum 8 characters
        - At least one uppercase letter
        - At least one lowercase letter
        - At least one number
        - At least one special character

        **Username Requirements**:
        - 3-30 characters
        - Letters, numbers, and underscores only
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
            example:
              username: johndoe
              email: john@example.com
              password: SecureP@ss123
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
              example:
                success: true
                message: Registration successful
                data:
                  user:
                    id: 1
                    username: johndoe
                    email: john@example.com
                    role: user
                    email_verified: false
                  accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  refreshToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '400':
          description: Validation error
          content:
            application/json:
              examples:
                invalidEmail:
                  value:
                    success: false
                    message: Invalid email format
                weakPassword:
                  value:
                    success: false
                    message: Password does not meet requirements
                    errors:
                      - Must be at least 8 characters
                      - Must contain an uppercase letter
                invalidUsername:
                  value:
                    success: false
                    message: Username must be 3-30 characters and contain only letters, numbers, and underscores
        '409':
          description: Email already exists
          content:
            application/json:
              example:
                success: false
                message: Email already registered
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              example:
                success: false
                message: Too many registration attempts. Please try again later.
                retryAfter: 3600

  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      description: |
        Authenticate user with email and password.

        **Rate Limit**: 10 requests per 15 minutes per IP

        **MFA Flow**: If user has 2FA enabled, returns `requiresMFA: true` with an `mfaToken` instead of access tokens. Use this token with `/api/auth/mfa/verify` to complete login.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              email: john@example.com
              password: SecureP@ss123
              rememberMe: false
      responses:
        '200':
          description: Login successful (or MFA required)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/LoginResponse'
                  - $ref: '#/components/schemas/MFARequiredResponse'
              examples:
                success:
                  summary: Login successful
                  value:
                    success: true
                    message: Login successful
                    data:
                      user:
                        id: 1
                        username: johndoe
                        email: john@example.com
                        role: user
                      accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                      refreshToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                mfaRequired:
                  summary: MFA verification required
                  value:
                    success: true
                    requiresMFA: true
                    mfaToken: temp_mfa_token_here
                    message: MFA verification required
        '401':
          description: Invalid credentials
          content:
            application/json:
              example:
                success: false
                message: Invalid email or password
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              example:
                success: false
                message: Too many login attempts. Please try again later.
                retryAfter: 900

  /api/auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: |
        Get a new access token using a valid refresh token.

        Use this endpoint when the access token expires (1 hour) to get a new one without requiring the user to login again.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  description: The refresh token received from login
            example:
              refreshToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              example:
                success: true
                message: Token refreshed
                data:
                  accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              example:
                success: false
                message: Invalid refresh token

  /api/auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user
      description: |
        Logout the current user and invalidate their session.

        This endpoint invalidates the current session in the database, preventing the refresh token from being used.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              example:
                success: true
                message: Logged out successfully
        '401':
          description: Not authenticated
          content:
            application/json:
              example:
                success: false
                message: Authentication required

  /api/auth/forgot-password:
    post:
      tags:
        - Authentication
      summary: Request password reset
      description: |
        Send a password reset email to the user.

        **Rate Limit**: 3 requests per hour per IP

        **Security Note**: Always returns success even if email doesn't exist to prevent email enumeration attacks.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
            example:
              email: john@example.com
      responses:
        '200':
          description: Password reset email sent (or would be sent if email exists)
          content:
            application/json:
              example:
                success: true
                message: If an account with that email exists, a password reset link has been sent
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              example:
                success: false
                message: Too many password reset attempts. Please try again later.
                retryAfter: 3600

  /api/auth/reset-password/{token}:
    post:
      tags:
        - Authentication
      summary: Reset password
      description: |
        Reset user password using the token from the password reset email.

        **Token Validity**: 1 hour

        The password must meet the same requirements as registration.
      parameters:
        - name: token
          in: path
          required: true
          description: Password reset token from email
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - password
              properties:
                password:
                  type: string
                  minLength: 8
                  description: New password (must meet strength requirements)
            example:
              password: NewSecureP@ss456
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              example:
                success: true
                message: Password has been reset successfully
        '400':
          description: Invalid or expired token, or weak password
          content:
            application/json:
              examples:
                invalidToken:
                  value:
                    success: false
                    message: Invalid or expired password reset token
                weakPassword:
                  value:
                    success: false
                    message: Password does not meet requirements
                    errors:
                      - Must be at least 8 characters

  /api/auth/verify-email/{token}:
    get:
      tags:
        - Authentication
      summary: Verify email address
      description: |
        Verify user email address using the token from the verification email.

        **Token Validity**: 24 hours

        After verification, the user's `email_verified` flag is set to true.
      parameters:
        - name: token
          in: path
          required: true
          description: Email verification token
          schema:
            type: string
      responses:
        '200':
          description: Email verified successfully
          content:
            application/json:
              example:
                success: true
                message: Email verified successfully
        '400':
          description: Invalid or expired token
          content:
            application/json:
              example:
                success: false
                message: Invalid or expired verification token

  /api/auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Get the currently authenticated user's information
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user data
          content:
            application/json:
              example:
                success: true
                data:
                  user:
                    id: 1
                    username: johndoe
                    email: john@example.com
                    role: user
                    email_verified: true
                    avatar_url: /uploads/avatars/1-abc123.jpg
                    created_at: '2025-11-01T10:00:00Z'
        '401':
          description: Not authenticated
          content:
            application/json:
              example:
                success: false
                message: Authentication required
